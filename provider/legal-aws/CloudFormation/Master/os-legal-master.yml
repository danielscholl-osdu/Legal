# Copyright Â© Amazon Web Services
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Creates all AWS resources used by OSDU's legal service. Requires having previously setup the CodeCommit repository,
  as well as the CodePipeline (manual template).
Parameters:
  Environment:
    Description: The name of the environment.
    Type: String
    AllowedValues:
      - dev
      - uat
      - prod
    ConstraintDescription: Environment can only be "dev/uat/prod".
    Default: dev

  DeploymentRegion:
    Description: The AWS region to deploy the resources to.
    Type: String
    Default: us-east-1

  LegalConfigS3BucketName:
    Description: The name of the legal service config S3 bucket. Defaults to osdu-legal-config.
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_-]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, -, and _ accepted. Max. length 64 characters.
    Default: osdu-legal-config
    Type: String
    MinLength: '1'
    MaxLength: '64'

  LegalRepositoryDynamoDBName:
    Description: The name of the DynamoDB table for the legal repository; will be prefixed by the environment (e.g. LegalRepository).
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, and _ accepted. Max. length 64 characters.
    Default: 'LegalRepository'
    Type: String
    MinLength: '1'
    MaxLength: '64'

  LegalServiceIamUsername:
    Description: The username of the service user for the Legal Repository.
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_-]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, -, and _ accepted. Max. length 64 characters.
    Type: String
    Default: service-user-os-legal
    MinLength: '1'
    MaxLength: '64'

  LegalServiceIamKeyRotationSerial:
    Description: This integer value can only ever be incremented, and an increase in value results in a rotation of the user's access key.
    Type: Number
    Default: 1

  LegalServiceSNSTopicName:
    Description: >-
      The name of the Simple Notification Service topic for the OSDU Legal Service. Defaults to osdu-legal-messages.
      Will be prefixed with the environment name.
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_-]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, -, and _ accepted. Max. length 64 characters.
    Default: osdu-legal-messages
    Type: String
    MinLength: '1'
    MaxLength: '64'

  LegalServiceSQSQueueName:
    Description: >-
      The name of the Simple Queue Service queue for the OSDU Legal Service. Defaults to osdu-legal-queue.
      Will be prefixed with the environment name.
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_-]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, -, and _ accepted. Max. length 64 characters.
    Default: osdu-legal-queue
    Type: String
    MinLength: '1'
    MaxLength: '64'
    
  ApplicationName:
    Description: >
      The name of the application, should be equal to the repository name.
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_-]*$"
    ConstraintDescription: Must start with a letter. Only numbers, letters, -, and _ accepted. Max. length 64 characters.
    Default: os-legal

  KeyName:
    Description: >
      Name of an existing EC2 KeyPair to enable SSH access to the ECS instances. Note that key pairs cannot
      be created through CloudFormation, but instead must be uploaded through the AWS Console.
    Type: AWS::EC2::KeyPair::KeyName
    Default: ecs_legal_key

  DesiredCapacity:
    Description: The default number of instances to launch in the ECS cluster.
    Type: Number
    Default: '1'

  MinSize:
    Description: Minimum number of instances that can be launched in the ECS cluster.
    Type: Number
    Default: '1'

  MaxSize:
    Description: Maximum number of instances that can be launched in the ECS cluster.
    Type: Number
    Default: '1'

  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t3.large
    AllowedValues:
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.16xlarge
      - m5.24xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m4.16xlarge
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.12xlarge
      - c5.16xlarge
      - c5.24xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.12xlarge
      - r5.24xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.16xlarge
      - i3.large
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.10xlarge
      - i3.16xlarge
      - x1e.xlarge
      - x1e.2xlarge
      - x1e.4xlarge
      - x1e.8xlarge
      - x1e.16xlarge
      - x1e.32xlarge
    ConstraintDescription: Please choose a valid EC2 instance type for the ECS container instances.

  ECSPort:
    Description: The port that the ECS Service will listen on.
    Type: Number
    Default: 80
    MinValue: 1
    MaxValue: 65535

  ECSCPUAllocation:
    Description: The amount of CPU resources to allocate to each ECS task/container. Scale - 1024 = 1 vCPU core.
    Type: Number
    Default: 1024
    MinValue: 10
    MaxValue: 65535

  ECSMemoryAllocation:
    Description: The amount of memory (RAM) to allocate to each ECS task/container. Scale - 1 = 1MB of memory.
    Type: Number
    Default: 2048
    MinValue: 256
    MaxValue: 131072

  DomainName:
    Description: >-
      The optional custom DNS name for the ECS service's load balancer. If omitted, the site will only be accessible
      via the ECS service's Application Load Balancer DNS name. This value is used in the creation and signing of
      the service's SSL certificate. Leave blank is not using a custom domain for this deployment.
    Type: String
    Default: ''

  HostedZoneName:
    Description: >-
      The name of the hosted zone (ex: for storage.osdu.slb.com, this would likely be osdu.slb.com).
      Leave blank is not using a custom domain for this deployment.
    Type: String
    Default: ''

  AcmCertificateArn:
    Description: >-
      The Amazon Resource Name (ARN) of an existing AWS Certificate Manager (ACM) certificate.
      If omitted, a new SSL certified will be requested/generated (only if the custom domain name
      parameter is provided, otherwise the ECS service's ALB will not use SSL/HTTPS).
    Type: String
    AllowedPattern: "^(|arn:aws:acm:.*)$"
    Default: ''

  VersionNumber:
    Description: The version number for the service jar being produced
    Type: String
    Default: '0.0.1'

  ServiceName:
    Description: >-
      The service name associated with the jar package for the Dockerfile.
    Type: String
    Default: 'legal'

Resources:

  #### Shared Resources ################################################################

  IAMCredentialsStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: iam-credentials.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        LegalServiceIamUsername: !Ref LegalServiceIamUsername
        LegalServiceIamKeyRotationSerial: !Ref LegalServiceIamKeyRotationSerial

  MessageBusSNSStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: sns-topic.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        SNSTopicName: !Ref LegalServiceSNSTopicName
        SQSQueueName: !Ref LegalServiceSQSQueueName

  #### ECS Resources ###################################################################

  ECSNetworkStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn: IAMCredentialsStack
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: ecs-network.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        ApplicationName: !Ref ApplicationName
        ECSPort: !Ref ECSPort
        DomainName: !Ref DomainName
        AcmCertificateArn: !Ref AcmCertificateArn

  ECSClusterStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn: ECSNetworkStack
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: ecs-cluster.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        ApplicationName: !Ref ApplicationName
        KeyName: !Ref KeyName
        DesiredCapacity: !Ref DesiredCapacity
        MaxSize: !Ref MaxSize
        InstanceType: !Ref InstanceType
        ECSPort: !Ref ECSPort
        SNSTopicName: !Ref LegalServiceSNSTopicName
        LegalConfigS3BucketName: !Ref LegalConfigS3BucketName
        ECSMemoryAllocation: !Ref ECSMemoryAllocation
        DomainName: !Ref DomainName
        HostedZoneName: !Ref HostedZoneName
        VersionNumber: !Ref VersionNumber
        ServiceName: !Ref ServiceName

  #### Legal Repository DB #############################################################

  LegalRepositoryStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: legal-repository.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        TableName: !Ref LegalRepositoryDynamoDBName

  #### Legal Config Bucket #############################################################

  LegalConfigBucketStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn: IAMCredentialsStack
    Properties:
      TemplateURL: !Sub
        - https://s3.amazonaws.com/${CloudFormationS3Bucket}/${ApplicationName}/Automated/${CFNTemplateFilename}
        - CloudFormationS3Bucket: !ImportValue
            'Fn::Sub': '${Environment}-S3BucketCloudFormation'
          CFNTemplateFilename: config-bucket.yml
      Parameters:
        Environment: !Ref Environment
        Region: !Ref DeploymentRegion
        LegalConfigBucketName: !Ref LegalConfigS3BucketName
